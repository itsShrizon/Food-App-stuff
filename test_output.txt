/home/tanzir/Downloads/RepoGraveyard/Food-App-stuff/.venv_new/lib/python3.12/site-packages/pytest_asyncio/plugin.py:247: PytestDeprecationWarning: The configuration option "asyncio_default_fixture_loop_scope" is unset.
The event loop scope for asynchronous fixtures will default to the fixture caching scope. Future versions of pytest-asyncio will default the loop scope for asynchronous fixtures to function scope. Set the default fixture loop scope explicitly in order to avoid unexpected behavior in the future. Valid fixture loop scopes are: "function", "class", "module", "package", "session"

  warnings.warn(PytestDeprecationWarning(_DEFAULT_FIXTURE_LOOP_SCOPE_UNSET))
============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-8.3.4, pluggy-1.6.0
rootdir: /home/tanzir/Downloads/RepoGraveyard/Food-App-stuff
plugins: asyncio-1.3.0, anyio-4.12.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 59 items

test_meal_generator.py .......F.FFF..FF.FF.FFF                           [ 38%]
test_onboarding.py ..............FFFFF.F.......F......F                  [100%]

=================================== FAILURES ===================================
________________ TestGenerateMeal.test_missing_required_fields _________________

self = <test_meal_generator.TestGenerateMeal object at 0x743552895a90>

    def test_missing_required_fields(self):
        """Test that missing required fields raises ValueError."""
        incomplete_info = {"gender": "male"}
    
        with pytest.raises(ValueError, match="Missing required user_info fields"):
>           generate_meal(incomplete_info, meal_type="Lunch")

test_meal_generator.py:90: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/services/meal_generator/generator.py:36: in generate_meal
    validate_user_info(user_info, REQUIRED_USER_FIELDS)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

user_info = {'gender': 'male'}
required_fields = ['gender', 'date_of_birth', 'current_height', 'current_weight', 'current_weight_unit', 'target_weight', ...]

    def validate_user_info(user_info: Dict[str, Any], required_fields: List[str]) -> None:
        """Validate that user_info contains required fields."""
        missing = [f for f in required_fields if f not in user_info]
        if missing:
>           raise ValueError(f"Missing required fields: {missing}")
E           ValueError: Missing required fields: ['date_of_birth', 'current_height', 'current_weight', 'current_weight_unit', 'target_weight', 'target_weight_unit', 'goal', 'activity_level']

app/services/meal_generator/utils.py:92: ValueError

During handling of the above exception, another exception occurred:

self = <test_meal_generator.TestGenerateMeal object at 0x743552895a90>

    def test_missing_required_fields(self):
        """Test that missing required fields raises ValueError."""
        incomplete_info = {"gender": "male"}
    
>       with pytest.raises(ValueError, match="Missing required user_info fields"):
E       AssertionError: Regex pattern did not match.
E        Regex: 'Missing required user_info fields'
E        Input: "Missing required fields: ['date_of_birth', 'current_height', 'current_weight', 'current_weight_unit', 'target_weight', 'target_weight_unit', 'goal', 'activity_level']"

test_meal_generator.py:89: AssertionError
_________________ TestGenerateMeal.test_generate_meal_success __________________

self = <test_meal_generator.TestGenerateMeal object at 0x743552895d60>
mock_chatbot = <MagicMock name='chatbot' id='127772366205104'>

    @patch("app.core.llm.chatbot")
    def test_generate_meal_success(self, mock_chatbot):
        """Test successful meal generation."""
        mock_chatbot.return_value = json.dumps({
            "meal_type": "Lunch",
            "meal_name": "Grilled Chicken Salad",
            "meal_description": "A healthy protein-rich salad",
            "ingredients": [
                {"name": "Chicken breast", "amount": "150g"},
                {"name": "Mixed greens", "amount": "100g"}
            ],
            "preparation_time": "20 minutes",
            "cooking_instructions": "Grill chicken, slice, serve over greens",
            "nutritional_info": {
                "calories": "320kcal",
                "protein": "35g",
                "carbohydrate": "8g",
                "fat": "15g"
            }
        })
    
        user_info = self.get_sample_user_info()
        result = generate_meal(user_info, meal_type="Lunch")
    
>       assert result["meal_type"] == "lunch"
E       AssertionError: assert 'Lunch' == 'lunch'
E         
E         - lunch
E         ? ^
E         + Lunch
E         ? ^

test_meal_generator.py:130: AssertionError
__________ TestGenerateMeal.test_generate_meal_with_markdown_cleanup ___________

self = <test_meal_generator.TestGenerateMeal object at 0x743552895d30>
mock_chatbot = <MagicMock name='chatbot' id='127772364906592'>

        @patch("app.core.llm.chatbot")
        def test_generate_meal_with_markdown_cleanup(self, mock_chatbot):
            """Test that markdown code blocks are cleaned from response."""
            mock_chatbot.return_value = """```json
    {
        "meal_type": "Breakfast",
        "meal_name": "Protein Oatmeal",
        "meal_description": "Healthy breakfast",
        "ingredients": [{"name": "Oats", "amount": "50g"}],
        "preparation_time": "10 minutes",
        "cooking_instructions": "Cook oats with water",
        "nutritional_info": {
            "calories": "250kcal",
            "protein": "15g",
            "carbohydrate": "40g",
            "fat": "5g"
        }
    }```"""
    
            user_info = self.get_sample_user_info()
            result = generate_meal(user_info, meal_type="Breakfast")
    
>           assert result["meal_type"] == "breakfast"
E           AssertionError: assert 'Breakfast' == 'breakfast'
E             
E             - breakfast
E             ? ^
E             + Breakfast
E             ? ^

test_meal_generator.py:158: AssertionError
__________ TestGenerateMeal.test_generate_meal_missing_required_keys ___________

self = <test_meal_generator.TestGenerateMeal object at 0x743552895e80>
mock_chatbot = <MagicMock name='chatbot' id='127772364913984'>

    @patch("app.core.llm.chatbot")
    def test_generate_meal_missing_required_keys(self, mock_chatbot):
        """Test that incomplete meal data raises ValueError."""
        mock_chatbot.return_value = json.dumps({
            "meal_type": "Lunch",
            "meal_description": "Incomplete meal"
            # Missing meal_name, ingredients, nutritional_info
        })
    
        user_info = self.get_sample_user_info()
    
>       with pytest.raises(ValueError, match="missing required keys"):
E       Failed: DID NOT RAISE <class 'ValueError'>

test_meal_generator.py:172: Failed
_ TestGenerateMealWithPreviousMeals.test_generate_meal_with_one_previous_meal __

self = <test_meal_generator.TestGenerateMealWithPreviousMeals object at 0x743552896420>
mock_chatbot = <MagicMock name='chatbot' id='127772364693024'>

    @patch("app.core.llm.chatbot")
    def test_generate_meal_with_one_previous_meal(self, mock_chatbot):
        """Test that previous meal names are included in the prompt."""
        mock_chatbot.return_value = json.dumps({
            "meal_type": "Snacks",
            "meal_name": "Greek Yogurt with Berries",
            "meal_description": "High protein snack",
            "ingredients": [
                {"name": "Greek yogurt", "amount": "150g"},
                {"name": "Berries", "amount": "50g"}
            ],
            "preparation_time": "5 minutes",
            "cooking_instructions": "Mix yogurt with berries",
            "nutritional_info": {
                "calories": "150kcal",
                "protein": "15g",
                "carbohydrate": "18g",
                "fat": "3g"
            }
        })
    
        previous_meals = [
            {
                "meal_type": "Breakfast",
                "meal_name": "Oatmeal with Banana",
                "ingredients": [{"name": "Oats", "amount": "50g"}]
            }
        ]
    
        user_info = self.get_sample_user_info()
        result = generate_meal(user_info, meal_type="Snacks", previous_meals=previous_meals)
    
        # Check that chatbot was called with previous meals context
        assert mock_chatbot.called
        call_args = mock_chatbot.call_args[0]
>       prompt = call_args[0]
E       IndexError: tuple index out of range

test_meal_generator.py:277: IndexError
_ TestGenerateMealWithPreviousMeals.test_generate_meal_with_multiple_previous_meals _

self = <test_meal_generator.TestGenerateMealWithPreviousMeals object at 0x7435528965a0>
mock_chatbot = <MagicMock name='chatbot' id='127772364692208'>

    @patch("app.core.llm.chatbot")
    def test_generate_meal_with_multiple_previous_meals(self, mock_chatbot):
        """Test meal generation with multiple previous meals."""
        mock_chatbot.return_value = json.dumps({
            "meal_type": "Dinner",
            "meal_name": "Chicken Stir Fry",
            "meal_description": "Asian-inspired dinner",
            "ingredients": [
                {"name": "Chicken breast", "amount": "150g"},
                {"name": "Mixed vegetables", "amount": "200g"},
                {"name": "Soy sauce", "amount": "2 tablespoons"}
            ],
            "preparation_time": "25 minutes",
            "cooking_instructions": "Stir fry chicken and vegetables",
            "nutritional_info": {
                "calories": "380kcal",
                "protein": "40g",
                "carbohydrate": "25g",
                "fat": "12g"
            }
        })
    
        previous_meals = [
            {
                "meal_type": "Breakfast",
                "meal_name": "Scrambled Eggs with Toast",
                "ingredients": [{"name": "Eggs", "amount": "2 pieces"}]
            },
            {
                "meal_type": "Snacks",
                "meal_name": "Apple with Almond Butter",
                "ingredients": [{"name": "Apple", "amount": "1 piece"}]
            },
            {
                "meal_type": "Lunch",
                "meal_name": "Grilled Chicken Salad",
                "ingredients": [{"name": "Chicken", "amount": "120g"}]
            }
        ]
    
        user_info = self.get_sample_user_info()
        result = generate_meal(user_info, meal_type="Dinner", previous_meals=previous_meals)
    
>       assert result["meal_type"] == "dinner"
E       AssertionError: assert 'Dinner' == 'dinner'
E         
E         - dinner
E         ? ^
E         + Dinner
E         ? ^

test_meal_generator.py:323: AssertionError
______ TestGenerateDailyMealPlan.test_generate_daily_meal_plan_all_meals _______

self = <test_meal_generator.TestGenerateDailyMealPlan object at 0x7435528968d0>
mock_chatbot = <MagicMock name='chatbot' id='127772364912064'>

    @patch("app.core.llm.chatbot")
    def test_generate_daily_meal_plan_all_meals(self, mock_chatbot):
        """Test that daily plan generates all 4 meal types."""
        # Mock responses for all 4 meals
        mock_chatbot.side_effect = [
            json.dumps({
                "meal_type": "Breakfast",
                "meal_name": "Protein Pancakes",
                "meal_description": "High protein breakfast",
                "ingredients": [{"name": "Eggs", "amount": "2 pieces"}],
                "preparation_time": "15 minutes",
                "cooking_instructions": "Mix and cook",
                "nutritional_info": {"calories": "300kcal", "protein": "25g", "carbohydrate": "35g", "fat": "8g"}
            }),
            json.dumps({
                "meal_type": "Snacks",
                "meal_name": "Protein Smoothie",
                "meal_description": "Quick snack",
                "ingredients": [{"name": "Protein powder", "amount": "30g"}],
                "preparation_time": "5 minutes",
                "cooking_instructions": "Blend all",
                "nutritional_info": {"calories": "180kcal", "protein": "20g", "carbohydrate": "15g", "fat": "5g"}
            }),
            json.dumps({
                "meal_type": "Lunch",
                "meal_name": "Chicken Caesar Salad",
                "meal_description": "Filling lunch",
                "ingredients": [{"name": "Chicken", "amount": "150g"}],
                "preparation_time": "20 minutes",
                "cooking_instructions": "Grill and toss",
                "nutritional_info": {"calories": "400kcal", "protein": "38g", "carbohydrate": "20g", "fat": "18g"}
            }),
            json.dumps({
                "meal_type": "Dinner",
                "meal_name": "Baked Salmon with Vegetables",
                "meal_description": "Healthy dinner",
                "ingredients": [{"name": "Salmon", "amount": "200g"}],
                "preparation_time": "30 minutes",
                "cooking_instructions": "Bake at 375F",
                "nutritional_info": {"calories": "450kcal", "protein": "42g", "carbohydrate": "15g", "fat": "25g"}
            })
        ]
    
        user_info = self.get_sample_user_info()
        meal_plan = generate_daily_meal_plan(user_info)
    
        # Check all meal types are present
>       assert "Breakfast" in meal_plan
E       AssertionError: assert 'Breakfast' in {'breakfast': {'cooking_instructions': 'N/A', 'ingredients': [{'name': 'Sample Ingredient', 'nutritional_info': {}, 'q... {}, 'quantity': '1', 'unit': 'serving'}], 'meal_description': 'No description provided.', 'meal_type': 'snacks', ...}}

test_meal_generator.py:428: AssertionError
_______ TestGenerateDailyMealPlan.test_daily_plan_passes_previous_meals ________

self = <test_meal_generator.TestGenerateDailyMealPlan object at 0x743552896a50>
mock_chatbot = <MagicMock name='chatbot' id='127772364906976'>

    @patch("app.core.llm.chatbot")
    def test_daily_plan_passes_previous_meals(self, mock_chatbot):
        """Test that each meal in daily plan receives previous meals."""
        meal_responses = []
        for meal_type, meal_name in [("Breakfast", "Oatmeal"), ("Snacks", "Nuts"),
                                      ("Lunch", "Salad"), ("Dinner", "Fish")]:
            meal_responses.append(json.dumps({
                "meal_type": meal_type,
                "meal_name": meal_name,
                "meal_description": "Test meal",
                "ingredients": [{"name": "Test", "amount": "100g"}],
                "preparation_time": "10 minutes",
                "cooking_instructions": "Cook it",
                "nutritional_info": {"calories": "200kcal", "protein": "20g", "carbohydrate": "10g", "fat": "5g"}
            }))
    
        mock_chatbot.side_effect = meal_responses
    
        user_info = self.get_sample_user_info()
        meal_plan = generate_daily_meal_plan(user_info)
    
        # Verify chatbot was called 4 times (once per meal)
>       assert mock_chatbot.call_count == 4
E       AssertionError: assert 1 == 4
E        +  where 1 = <MagicMock name='chatbot' id='127772364906976'>.call_count

test_meal_generator.py:462: AssertionError
_______________ TestDifferentUserProfiles.test_lose_weight_goal ________________

self = <test_meal_generator.TestDifferentUserProfiles object at 0x743552896db0>
mock_chatbot = <MagicMock name='chatbot' id='127772366204960'>

    @patch("app.core.llm.chatbot")
    def test_lose_weight_goal(self, mock_chatbot):
        """Test meal generation for weight loss goal."""
        mock_chatbot.return_value = json.dumps({
            "meal_type": "Lunch",
            "meal_name": "Light Salad",
            "meal_description": "Low calorie meal",
            "ingredients": [{"name": "Lettuce", "amount": "100g"}],
            "preparation_time": "10 minutes",
            "cooking_instructions": "Toss ingredients",
            "nutritional_info": {"calories": "250kcal", "protein": "20g", "carbohydrate": "15g", "fat": "10g"}
        })
    
        user_info = {
            "gender": "female",
            "date_of_birth": "1992-05-10",
            "current_height": "165",
            "current_weight": "70",
            "current_weight_unit": "kg",
            "target_weight": "65",
            "target_weight_unit": "kg",
            "goal": "lose weight",
            "activity_level": "sedentary"
        }
    
        result = generate_meal(user_info, meal_type="Lunch")
    
        # Verify chatbot was called with weight loss goal
        call_args = mock_chatbot.call_args[0]
>       prompt = call_args[0]
E       IndexError: tuple index out of range

test_meal_generator.py:525: IndexError
_______________ TestDifferentUserProfiles.test_gain_weight_goal ________________

self = <test_meal_generator.TestDifferentUserProfiles object at 0x743552896f30>
mock_chatbot = <MagicMock name='chatbot' id='127772366208224'>

    @patch("app.core.llm.chatbot")
    def test_gain_weight_goal(self, mock_chatbot):
        """Test meal generation for weight gain goal."""
        mock_chatbot.return_value = json.dumps({
            "meal_type": "Dinner",
            "meal_name": "Protein Bowl",
            "meal_description": "High calorie meal",
            "ingredients": [{"name": "Rice", "amount": "200g"}],
            "preparation_time": "25 minutes",
            "cooking_instructions": "Cook all ingredients",
            "nutritional_info": {"calories": "650kcal", "protein": "45g", "carbohydrate": "70g", "fat": "20g"}
        })
    
        user_info = {
            "gender": "male",
            "date_of_birth": "2000-08-20",
            "current_height": "185",
            "current_weight": "65",
            "current_weight_unit": "kg",
            "target_weight": "75",
            "target_weight_unit": "kg",
            "goal": "gain weight",
            "activity_level": "active"
        }
    
        result = generate_meal(user_info, meal_type="Dinner")
    
        # Verify chatbot was called with weight gain goal
        call_args = mock_chatbot.call_args[0]
>       prompt = call_args[0]
E       IndexError: tuple index out of range

test_meal_generator.py:557: IndexError
_____________ TestDifferentUserProfiles.test_maintain_weight_goal ______________

self = <test_meal_generator.TestDifferentUserProfiles object at 0x743552897080>
mock_chatbot = <MagicMock name='chatbot' id='127772365612592'>

    @patch("app.core.llm.chatbot")
    def test_maintain_weight_goal(self, mock_chatbot):
        """Test meal generation for weight maintenance."""
        mock_chatbot.return_value = json.dumps({
            "meal_type": "Breakfast",
            "meal_name": "Balanced Breakfast",
            "meal_description": "Maintenance calories",
            "ingredients": [{"name": "Eggs", "amount": "2 pieces"}],
            "preparation_time": "15 minutes",
            "cooking_instructions": "Prepare eggs",
            "nutritional_info": {"calories": "350kcal", "protein": "25g", "carbohydrate": "30g", "fat": "15g"}
        })
    
        user_info = {
            "gender": "female",
            "date_of_birth": "1988-11-15",
            "current_height": "170",
            "current_weight": "60",
            "current_weight_unit": "kg",
            "target_weight": "60",
            "target_weight_unit": "kg",
            "goal": "maintain",
            "activity_level": "moderate"
        }
    
        result = generate_meal(user_info, meal_type="Breakfast")
    
        # Verify chatbot was called with maintenance goal
        call_args = mock_chatbot.call_args[0]
>       prompt = call_args[0]
E       IndexError: tuple index out of range

test_meal_generator.py:589: IndexError
_____________ TestOnboardingIntegration.test_full_onboarding_flow ______________

self = <test_onboarding.TestOnboardingIntegration object at 0x743552704ce0>
mock_chatbot = <MagicMock name='chatbot' id='127772365014320'>

    @patch("app.core.llm.chatbot")
    def test_full_onboarding_flow(self, mock_chatbot):
        """Test complete onboarding flow from start to finish."""
        # Mock extraction to return all fields at once
        mock_chatbot.side_effect = [
            "Welcome! Let's get started...",  # start_onboarding greeting
            json.dumps({"macros_confirmed": True, "dietary": ["none"],
                "gender": "male",
                "date_of_birth": "1990-01-01",
                "current_height": "180 cm",
                "current_weight": "75 kg",
                "target_weight": "70 kg",
                "goal": "lose weight",
                "target_speed": "normal",
                "activity_level": "moderate"
            }),  # extraction response
        ]
    
        # Start onboarding
        result = start_onboarding()
        assert not result["is_complete"]
    
        # Provide all answers in one message
        result = onboarding(
            "I'm a male born on 1990-01-01, currently 180 cm tall and 75 kg. I want to lose weight to 70 kg at a normal pace. I'm moderately active.",
            collected_data=result["collected_data"],
            conversation_history=result["conversation_history"],
        )
    
        # Verify all required fields are collected
>       assert len(result["collected_data"]) == len(ONBOARDING_FIELDS)
E       AssertionError: assert 15 == 11
E        +  where 15 = len({'activity_level': 'moderate', 'current_height': 180.0, 'current_height_unit': 'cm', 'current_weight': 75.0, ...})
E        +  and   11 = len(('gender', 'date_of_birth', 'current_height', 'current_height_unit', 'current_weight', 'current_weight_unit', ...))

test_onboarding.py:301: AssertionError
________ TestOnboardingIntegration.test_onboarding_fields_completeness _________

self = <test_onboarding.TestOnboardingIntegration object at 0x743552704e90>

    def test_onboarding_fields_completeness(self):
        """Test that all required onboarding fields are defined."""
        expected_fields = (
            'gender', 'date_of_birth',
            'current_height',
            'current_weight',
            'target_weight',
            'goal',
            'target_speed',
            'activity_level'
        )
    
>       assert ONBOARDING_FIELDS == expected_fields
E       AssertionError: assert ('gender', 'd...ht_unit', ...) == ('gender', 'd..., 'goal', ...)
E         
E         At index 3 diff: 'current_height_unit' != 'current_weight'
E         Left contains 3 more items, first extra item: 'goal'
E         Use -v to get more diff

test_onboarding.py:316: AssertionError
_______ TestOnboardingWorkflows.test_workflow_1_single_response_all_info _______

self = <test_onboarding.TestOnboardingWorkflows object at 0x7435528e3d40>
mock_chatbot = <MagicMock name='chatbot' id='127772364669152'>

    @patch("app.core.llm.chatbot")
    def test_workflow_1_single_response_all_info(self, mock_chatbot):
        """Workflow 1: User provides all information in a single detailed response."""
        mock_chatbot.side_effect = [
            "Hello! Let's start...",  # start_onboarding
            json.dumps({"macros_confirmed": True, "dietary": ["none"],
                "gender": "male",
                "date_of_birth": "1985-03-15",
                "current_height": "5 foot 10 inches",
                "current_weight": "180 lbs",
                "target_weight": "165 lbs",
                "goal": "lose weight",
                "target_speed": "normal",
                "activity_level": "moderate"
            }),
        ]
    
        result = start_onboarding()
        result = onboarding(
            "I'm a 39 year old male born March 15, 1985. I'm 5 foot 10 inches and weigh 180 lbs. I want to lose weight down to 165 lbs at a normal pace. I exercise moderately.",
            collected_data=result["collected_data"],
            conversation_history=result["conversation_history"]
        )
    
        assert result["is_complete"] is True
>       assert len(result["collected_data"]) == 8
E       AssertionError: assert 15 == 8
E        +  where 15 = len({'activity_level': 'moderate', 'current_height': 5.0, 'current_height_unit': 'in', 'current_weight': 180.0, ...})

test_onboarding.py:347: AssertionError
___ TestOnboardingWorkflows.test_workflow_2_progressive_natural_conversation ___

self = <test_onboarding.TestOnboardingWorkflows object at 0x7435528e36e0>
mock_chatbot = <MagicMock name='chatbot' id='127772364676160'>

    @patch("app.core.llm.chatbot")
    def test_workflow_2_progressive_natural_conversation(self, mock_chatbot):
        """Workflow 2: User provides info progressively through natural conversation."""
        mock_chatbot.side_effect = [
            "Hi there!",  # start
            '{"gender": "female"}', "What's your date of birth?",
            '{"gender": "female", "date_of_birth": "1992-07-20"}', "Great! What's your height?",
            '{"gender": "female", "date_of_birth": "1992-07-20", "current_height": "165 cm"}', "What's your current weight?",
            '{"gender": "female", "date_of_birth": "1992-07-20", "current_height": "165 cm", "current_weight": "65 kg"}', "What's your target weight?",
            '{"gender": "female", "date_of_birth": "1992-07-20", "current_height": "165 cm", "current_weight": "65 kg", "target_weight": "60 kg"}', "What's your goal?",
            '{"gender": "female", "date_of_birth": "1992-07-20", "current_height": "165 cm", "current_weight": "65 kg", "target_weight": "60 kg", "goal": "lose weight"}', "How fast?",
            '{"gender": "female", "date_of_birth": "1992-07-20", "current_height": "165 cm", "current_weight": "65 kg", "target_weight": "60 kg", "goal": "lose weight", "target_speed": "slow"}', "Activity level?",
            '{"gender": "female", "date_of_birth": "1992-07-20", "current_height": "165 cm", "current_weight": "65 kg", "target_weight": "60 kg", "goal": "lose weight", "target_speed": "slow", "activity_level": "light"}',
        ]
    
        result = start_onboarding()
        responses = ["female", "July 20, 1992", "165 cm", "65 kg", "60 kg", "lose weight", "slow", "light exercise"]
    
        for response in responses:
            result = onboarding(response, collected_data=result["collected_data"], conversation_history=result["conversation_history"])
            if result["is_complete"]:
                break
    
>       assert result["is_complete"] is True
E       assert False is True

test_onboarding.py:372: AssertionError
----------------------------- Captured stdout call -----------------------------
Running with model: gpt-4.1-2025-04-14
Running with model: gpt-4.1-2025-04-14
Running with model: gpt-4.1-2025-04-14
Running with model: gpt-4.1-2025-04-14
Running with model: gpt-4.1-2025-04-14
Running with model: gpt-4.1-2025-04-14
Running with model: gpt-4.1-2025-04-14
_____________ TestOnboardingWorkflows.test_workflow_3_metric_units _____________

self = <test_onboarding.TestOnboardingWorkflows object at 0x743552704bf0>
mock_chatbot = <MagicMock name='chatbot' id='127772364680288'>

    @patch("app.core.llm.chatbot")
    def test_workflow_3_metric_units(self, mock_chatbot):
        """Workflow 3: User provides all measurements in metric units."""
        mock_chatbot.side_effect = [
            "Welcome!",
            json.dumps({"macros_confirmed": True, "dietary": ["none"],
                "gender": "male",
                "date_of_birth": "1990-01-01",
                "current_height": "180 cm",
                "current_weight": "75 kg",
                "target_weight": "70 kg",
                "goal": "lose weight",
                "target_speed": "fast",
                "activity_level": "active"
            }),
        ]
    
        result = start_onboarding()
        result = onboarding(
            "Male, born 1990-01-01, 180cm, 75kg, want to reach 70kg fast, very active lifestyle",
            collected_data=result["collected_data"],
            conversation_history=result["conversation_history"]
        )
    
        assert result["is_complete"] is True
>       assert "cm" in str(result["collected_data"].get("current_height", "")).lower() or result["collected_data"].get("current_height") == "180 cm"
E       AssertionError: assert ('cm' in '180.0' or 180.0 == '180 cm')
E        +  where '180.0' = <built-in method lower of str object at 0x74355268acd0>()
E        +    where <built-in method lower of str object at 0x74355268acd0> = '180.0'.lower
E        +      where '180.0' = str(180.0)
E        +        where 180.0 = <built-in method get of dict object at 0x7435526fc3c0>('current_height', '')
E        +          where <built-in method get of dict object at 0x7435526fc3c0> = {'activity_level': 'active', 'current_height': 180.0, 'current_height_unit': 'cm', 'current_weight': 75.0, ...}.get
E        +  and   180.0 = <built-in method get of dict object at 0x7435526fc3c0>('current_height')
E        +    where <built-in method get of dict object at 0x7435526fc3c0> = {'activity_level': 'active', 'current_height': 180.0, 'current_height_unit': 'cm', 'current_weight': 75.0, ...}.get

test_onboarding.py:399: AssertionError
___________ TestOnboardingWorkflows.test_workflow_5_gain_weight_goal ___________

self = <test_onboarding.TestOnboardingWorkflows object at 0x743552704770>
mock_chatbot = <MagicMock name='chatbot' id='127772365614464'>

    @patch("app.core.llm.chatbot")
    def test_workflow_5_gain_weight_goal(self, mock_chatbot):
        """Workflow 5: User wants to gain weight."""
        mock_chatbot.side_effect = [
            "Hi!",
            json.dumps({"macros_confirmed": True, "dietary": ["none"],
                "gender": "male",
                "date_of_birth": "2000-12-25",
                "current_height": "185 cm",
                "current_weight": "65 kg",
                "target_weight": "75 kg",
                "goal": "gain weight",
                "target_speed": "slow",
                "activity_level": "light"
            }),
        ]
    
        result = start_onboarding()
        result = onboarding(
            "Male, Dec 25 2000, 185cm, 65kg, want to gain weight to 75kg slowly, light activity",
            collected_data=result["collected_data"],
            conversation_history=result["conversation_history"]
        )
    
        assert result["is_complete"] is True
>       assert result["collected_data"]["goal"] == "gain weight"
E       AssertionError: assert 'gain_weight' == 'gain weight'
E         
E         - gain weight
E         ?     ^
E         + gain_weight
E         ?     ^

test_onboarding.py:452: AssertionError
________ TestOnboardingWorkflows.test_workflow_13_partial_then_complete ________

self = <test_onboarding.TestOnboardingWorkflows object at 0x743552705940>
mock_chatbot = <MagicMock name='chatbot' id='127772364908608'>

    @patch("app.core.llm.chatbot")
    def test_workflow_13_partial_then_complete(self, mock_chatbot):
        """Workflow 13: User provides partial info, then completes later."""
        mock_chatbot.side_effect = [
            "Welcome!",
            '{"gender": "female", "date_of_birth": "1996-03-20"}', "Great! What about your measurements?",
            '{"gender": "female", "date_of_birth": "1996-03-20", "current_height": "168 cm", "current_weight": "72 kg", "target_weight": "65 kg", "goal": "lose weight", "target_speed": "normal", "activity_level": "light"}',
        ]
    
        result = start_onboarding()
        result = onboarding(
            "I'm a woman born March 20, 1996",
            collected_data=result["collected_data"],
            conversation_history=result["conversation_history"]
        )
    
        assert result["is_complete"] is False
    
        result = onboarding(
            "I'm 168cm, 72kg, want to reach 65kg at normal pace, I do light exercise",
            collected_data=result["collected_data"],
            conversation_history=result["conversation_history"]
        )
    
>       assert result["is_complete"] is True
E       assert False is True

test_onboarding.py:666: AssertionError
----------------------------- Captured stdout call -----------------------------
Running with model: gpt-4.1-2025-04-14
_____ TestOnboardingWorkflows.test_workflow_20_casual_conversational_style _____

self = <test_onboarding.TestOnboardingWorkflows object at 0x7435527063c0>
mock_chatbot = <MagicMock name='chatbot' id='127772364993600'>

    @patch("app.core.llm.chatbot")
    def test_workflow_20_casual_conversational_style(self, mock_chatbot):
        """Workflow 20: Very casual, conversational style with slang."""
        mock_chatbot.side_effect = [
            "Hey!",
            json.dumps({"macros_confirmed": True, "dietary": ["none"],
                "gender": "female",
                "date_of_birth": "1997-09-05",
                "current_height": "170 cm",
                "current_weight": "65 kg",
                "target_weight": "62 kg",
                "goal": "lose weight",
                "target_speed": "normal",
                "activity_level": "moderate"
            }),
        ]
    
        result = start_onboarding()
        result = onboarding(
            "Hey! So I'm a girl, born Sept 5 97. I'm like 170cm tall, weigh about 65kg rn but wanna get to 62kg ya know? Normal speed is cool. I hit the gym a few times a week so pretty moderate I guess",
            collected_data=result["collected_data"],
            conversation_history=result["conversation_history"]
        )
    
        assert result["is_complete"] is True
>       assert len(result["collected_data"]) == 8
E       AssertionError: assert 15 == 8
E        +  where 15 = len({'activity_level': 'moderate', 'current_height': 170.0, 'current_height_unit': 'cm', 'current_weight': 65.0, ...})

test_onboarding.py:850: AssertionError
=============================== warnings summary ===============================
test_meal_generator.py: 172 warnings
  /home/tanzir/Downloads/RepoGraveyard/Food-App-stuff/.venv_new/lib/python3.12/site-packages/langchain_core/load/serializable.py:289: PydanticDeprecatedSince211: Accessing the 'model_fields' attribute on the instance is deprecated. Instead, you should access this attribute from the model class. Deprecated in Pydantic V2.11 to be removed in V3.0.
    field = inst.model_fields.get(key)

test_meal_generator.py: 80 warnings
  /home/tanzir/Downloads/RepoGraveyard/Food-App-stuff/.venv_new/lib/python3.12/site-packages/langchain_core/load/serializable.py:213: PydanticDeprecatedSince211: Accessing the 'model_fields' attribute on the instance is deprecated. Instead, you should access this attribute from the model class. Deprecated in Pydantic V2.11 to be removed in V3.0.
    if k in self.model_fields and self.model_fields[k].exclude:

test_meal_generator.py: 60 warnings
  /home/tanzir/Downloads/RepoGraveyard/Food-App-stuff/.venv_new/lib/python3.12/site-packages/langchain_core/load/serializable.py:249: PydanticDeprecatedSince211: Accessing the 'model_fields' attribute on the instance is deprecated. Instead, you should access this attribute from the model class. Deprecated in Pydantic V2.11 to be removed in V3.0.
    if key in this.model_fields:

test_meal_generator.py: 32 warnings
  /home/tanzir/Downloads/RepoGraveyard/Food-App-stuff/.venv_new/lib/python3.12/site-packages/langchain_core/load/serializable.py:250: PydanticDeprecatedSince211: Accessing the 'model_fields' attribute on the instance is deprecated. Instead, you should access this attribute from the model class. Deprecated in Pydantic V2.11 to be removed in V3.0.
    alias = this.model_fields[key].alias

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED test_meal_generator.py::TestGenerateMeal::test_missing_required_fields
FAILED test_meal_generator.py::TestGenerateMeal::test_generate_meal_success
FAILED test_meal_generator.py::TestGenerateMeal::test_generate_meal_with_markdown_cleanup
FAILED test_meal_generator.py::TestGenerateMeal::test_generate_meal_missing_required_keys
FAILED test_meal_generator.py::TestGenerateMealWithPreviousMeals::test_generate_meal_with_one_previous_meal
FAILED test_meal_generator.py::TestGenerateMealWithPreviousMeals::test_generate_meal_with_multiple_previous_meals
FAILED test_meal_generator.py::TestGenerateDailyMealPlan::test_generate_daily_meal_plan_all_meals
FAILED test_meal_generator.py::TestGenerateDailyMealPlan::test_daily_plan_passes_previous_meals
FAILED test_meal_generator.py::TestDifferentUserProfiles::test_lose_weight_goal
FAILED test_meal_generator.py::TestDifferentUserProfiles::test_gain_weight_goal
FAILED test_meal_generator.py::TestDifferentUserProfiles::test_maintain_weight_goal
FAILED test_onboarding.py::TestOnboardingIntegration::test_full_onboarding_flow
FAILED test_onboarding.py::TestOnboardingIntegration::test_onboarding_fields_completeness
FAILED test_onboarding.py::TestOnboardingWorkflows::test_workflow_1_single_response_all_info
FAILED test_onboarding.py::TestOnboardingWorkflows::test_workflow_2_progressive_natural_conversation
FAILED test_onboarding.py::TestOnboardingWorkflows::test_workflow_3_metric_units
FAILED test_onboarding.py::TestOnboardingWorkflows::test_workflow_5_gain_weight_goal
FAILED test_onboarding.py::TestOnboardingWorkflows::test_workflow_13_partial_then_complete
FAILED test_onboarding.py::TestOnboardingWorkflows::test_workflow_20_casual_conversational_style
================= 19 failed, 40 passed, 344 warnings in 28.58s =================
